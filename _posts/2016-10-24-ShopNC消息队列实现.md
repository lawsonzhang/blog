---
layout: post
title:  "ShopNC消息队列实现"
date:   2016-10-24
desc: "ShopNC消息队列实现梳理"
keywords: "php, queue"
categories: [PHP]
tags: [php]
icon: icon-php
---


## ShopNC的消息队列使用的是Redis的list实现。

### 以下单成功给商家消息推送为例，下单成功后执行：
``` php
    // 发送商家提醒
    $param = array();
    $param['code'] = 'new_order';
    $param['store_id'] = $orderInfo['store_id'];
    $param['param'] = array(
        'order_sn' => $orderInfo['order_sn']
    );
    QueueClient::push('sendStoreMsg', $param);
```

### QueueClient代码如下 主要执行入列逻辑，'sendStoreMsg'是所有推送店铺消息共用key，如果消息队列未开启，就直接去执行发送信息逻辑方法
``` php
class QueueClient {

    private static $queuedb;

    /**
     * 入列
     * @param string $key
     * @param array $value
     */
    public static function push($key, $value) {
        if (!C('queue.open')) {
            Logic('queue')->$key($value);return;
        }
        if (!is_object(self::$queuedb)) {
            self::$queuedb = new QueueDB();
        }
        return self::$queuedb->push(serialize(array($key=>$value)));
    }
}
```

### 再说出列： cron脚本定时执行 /crontab/index.php?act=queue，这会执行crontab文件夹下的queue.php里的indexOp方法， 这个方法里的代码主要执行消息队列的出列操作

``` php
    $logicQueue = Logic('queue');// 实例化/data/logic/queue.php中的 queueLogic类
    $worker = new QueueServer();// 实例化 /core/framework/libraries/queue.php中的QueueServer类
    $queues = $worker->scan();// 扫描list中所有内容
    while (true) {
        $content = $worker->pop($queues,1800);// 取出队列中所有内容
        if (is_array($content)) {
            $method = key($content);// 取出列中的键值 当时以方法名存储
            $arg = current($content);// 取出内容 反序列化
            $result = $logicQueue->$method($arg);// 执行queueLogic中的选定方法
            if (!$result['state']) {
                $this->log($result['msg'],false);
            }
        } else {
            $model = Model();
            $model->checkActive();
            unset($model);
        }
    }
```

### QueueServer类主要去调用QueueDB中的方法
``` php
class QueueServer {

    private $_queuedb;
    
    public function __construct() {
        $this->_queuedb = new QueueDB();
    }

    /**
     * 取出队列
     * @param unknown $key
     */
    public function pop($key,$time) {
        return unserialize($this->_queuedb->pop($key,$time));
    }

    public function scan() {
        return $this->_queuedb->scan();
    }
}
```

### QueueDB代码如下 lpush入列 brpop出列
``` php
class QueueDB {

    //定义对象
    private $_redis;

    //存储前缀
    private $_tb_prefix = 'QUEUE_TABLE_';

    //存定义存储表的数量,系统会随机分配存储
    private $_tb_num = 2;

    //临时存储表
    private $_tb_tmp = 'TMP_TABLE';

    /**
     * 初始化
     */
    public function __construct() {
        if ( !extension_loaded('redis') ) {
            throw_exception('redis failed to load');
        }
        $this->_redis = new Redis();
        $this->_redis->connect(C('queue.host'),C('queue.port'));
    }

    /**
     * 入列
     * @param unknown $value
     */
    public function push($value) {
        try {
            return $this->_redis->lPush($this->_tb_prefix.rand(1,$this->_tb_num),$value);
        }catch(Exception $e) {
             throw_exception($e->getMessage());
        }
    }
    /**
     * 取得所有的list key(表)
     */
    public function scan() {
        $list_key = array();
        for($i=1;$i<=$this->_tb_num;$i++) {
            $list_key[] = $this->_tb_prefix.$i;
        }
        return $list_key;
    }
    /**
     * 出列
     * @param unknown $key
     */
    public function pop($key, $time) {
        try {
            if ($result = $this->_redis->brPop($key,$time)) {
                return $result[1];
            }
        } catch (Exception $e) {
            exit($e->getMessage());
        }
    }
    /**
     * 清空,暂时无用
     */
    public function clear() {
        $this->_redis->flushAll();
    }
}
```

### 在执行消息中key执行方法
``` php
/**
 * 发送店铺消息
 */
public function sendStoreMsg($param) {
    $send = new sendStoreMsg();
    $send->set('code', $param['code']);
    $send->set('store_id', $param['store_id']);

    if ($param['code'] == 'new_order') {
        $send->set('pandaeeWorkerMobile',
           	array(
               '13003297107', //李晨艳
               '15370777530', //杨蓓
               '15121192885', //张敏
               '15618297863', //阿飞
           	)
        );
    }
    $send->send($param['param']);
    // 新订单产生推送至商家
    if ($param['code'] == 'new_order') {
        $send->pushToApp($param['store_id']);
    }
    return callback(true);
}
```

### 会实例化一个sendStoreMsg类
``` php
/**
 * 商家有新订单的推送
 */
public function pushToApp($storeId)
{
    $storeInfo = Model('store')->getStoreInfoByID($storeId);
    $sellerMemberId = $storeInfo['member_id'];
    Push::pushOrderToSeller($sellerMemberId);
}
```